<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Latest Posts &#8211; Ackerley's Blog</title>
<meta name="description" content="Listing of Posts.">
<meta name="keywords" content="Jekyll, theme, themes, responsive, blog, modern">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Latest Posts">
<meta property="og:description" content="Listing of Posts.">
<meta property="og:url" content="http://ackerleytng.github.io/">
<meta property="og:site_name" content="Ackerley's Blog">





<link rel="canonical" href="http://ackerleytng.github.io/">
<link href="http://ackerleytng.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="Ackerley's Blog Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://ackerleytng.github.io/assets/css/main.min.css">
<!-- Webfonts -->
<link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://ackerleytng.github.io/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://ackerleytng.github.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://ackerleytng.github.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://ackerleytng.github.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://ackerleytng.github.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://ackerleytng.github.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://ackerleytng.github.io/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://ackerleytng.github.io">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://ackerleytng.github.io/images/avatar.jpg" alt="Ackerley Tng photo" class="author-photo">
					<h4>Ackerley Tng</h4>
					<p>Electrical Engineer at heart. Interested in Computer Architecture, cooking, skating, life, singing and efficiency in general</p>
				</li>
				<li><a href="http://ackerleytng.github.io/about/">Learn More</a></li>
				<li>
					<a href="mailto:ackerleytng@gmail.com"><i class="fa fa-envelope"></i> Email</a>
				</li>
				
				
				
				
				
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://ackerleytng.github.io/posts/">All Posts</a></li>
				<li><a href="http://ackerleytng.github.io/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->


<div class="entry-header">
  <div class="image-credit">Image source: <a href="http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/">dargadgetz</a></div><!-- /.image-credit -->
  
    <div class="entry-image">
      <img src="http://ackerleytng.github.io/images/abstract-1.jpg" alt="Latest Posts">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Ackerley's Blog</h1>
      <h2>Latest Posts</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
<article class="hentry">
  <header>
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2015-11-22T00:00:00+08:00"><a href="http://ackerleytng.github.io/new-project-common-lisp/">November 22, 2015</a></time></span><span class="author vcard"><span class="fn"><a href="http://ackerleytng.github.io/about/" title="About Ackerley Tng">Ackerley Tng</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://ackerleytng.github.io/new-project-common-lisp/#disqus_thread">Comment</a></span>
      
      <span class="entry-reading-time pull-right">
        <i class="fa fa-clock-o"></i>
        
        Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://ackerleytng.github.io/new-project-common-lisp/" rel="bookmark" title="Starting a new project in Common Lisp" itemprop="url">Starting a new project in Common Lisp</a></h1>
    
  </header>
  <div class="entry-content">
    <p>Is it fair to say that there aren&#39;t that many up-to-date books for common lisp that would help a beginner who doesn&#39;t want to start with a prebuilt environment?</p>

<p>I want to try and set up as much of my own environment as possible because</p>

<ul>
<li>I don&#39;t want to download multiple environments for my computer</li>
<li>I want to know how the environment was set up so that I will know how to replicate it</li>
</ul>

<p>There are many good books but a lot of them use old syntax, or they don&#39;t explain how to work with quicklisp...</p>

<p>The Common Lisp world feels fragmented because there are so many ways to do things, and many guides (if the guides exist) assume a certain setup. This makes the guide difficult to follow if you don&#39;t want to start at the beginning. I think this is probably a side effect of the power of lisp - people can build entire environments on their own, and they become so used to it that they forget what it is like for a beginner. These people are the ones who write books, so that makes it really difficult to understand for a beginner.</p>

<p>Anyway.</p>

<h1>Setup</h1>

<p>So quicklisp is like a package manager for existing lisp projects. It&#39;s something like gems for ruby and pip for python. You need it. <a href="https://www.quicklisp.org/beta/">Install it from here.</a> If you don&#39;t need the package vecto you can skip all the vecto stuff, but remember this <code>(ql:add-to-init-file)</code>. We want quicklisp to autostart with sbcl.</p>

<p>Then, we want to enable asdf in slime, in emacs. Go to your <code>.emacs</code> file, make sure you see <code>slime-asdf</code> in this list:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(setq slime-contribs &#39;(slime-fancy slime-asdf))
</code></pre></div>
<p>This will enable <code>slime-load-system</code> later to load <code>.asd</code> files.</p>

<h1>How to start programming</h1>

<p>Start sbcl, then first load quickproject with quicklisp, then use quickproject to make your project.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ sbcl
This is SBCL 1.3.0, an implementation of ANSI Common Lisp.
More information about SBCL is available at &lt;http://www.sbcl.org/&gt;.

SBCL is free software, provided as is, with absolutely no warranty.
It is mostly in the public domain; some portions are provided under
BSD-style licenses.  See the CREDITS and COPYING files in the
distribution for more information.
* (ql:quickload :quickproject)
To load &quot;quickproject&quot;:
  Load 1 ASDF system:
    quickproject
; Loading &quot;quickproject&quot;

(:QUICKPROJECT)
* (quickproject:make-project #p&quot;~/src/test/&quot; :depends-on &#39;(cl-ppcre))

&quot;myproject&quot;
</code></pre></div>
<p>That creates a project in <code>~/src/test/</code> and makes it depend on <code>cl-ppcre</code>.</p>

<p>I think of <code>quickproject</code> as something like <code>rails new &lt;project&gt;</code>. It builds you a skeleton. This is the skeleton.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ ls
README.txt   package.lisp test.asd     test.lisp
</code></pre></div>
<p>I think <code>package.lisp</code> is like a C header file, except that it is all headers in one.</p>

<p><code>test.asd</code> is like a <code>Gemfile</code>, which defines the packages, the files, the dependencies.</p>

<p><code>test.lisp</code> is where you want to be programming in.</p>

<p>Now open <code>test.asd</code> in emacs.</p>

<p>The repl should start on it&#39;s own, presenting you with a <code>CL-USER&gt;</code> prompt. <code>CL-USER</code> is actually the package that you&#39;re currently working in.</p>

<p>I&#39;ll add something to <code>test.lisp</code> so we can test it.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(defun hello-world ()
  &#39;hello-world)
</code></pre></div>
<p>Compile <code>test.asd</code>. With your cursor in <code>test.asd</code>&#39;s frame, press <code>C-c C-k</code>. Then load the system using <code>M-x slime-load-system</code> and then pick <code>test</code> as the system to load. Now go over to the repl frame, and then you want to switch to the package that you&#39;re working on. Pick one of two ways:</p>

<ul>
<li>type <code>(in-package :test)</code> at the repl</li>
<li>press <code>,</code> at the prompt to use slime shortcuts, then type either 

<ul>
<li><code>!p</code></li>
<li><code>change-package</code></li>
</ul></li>
</ul>

<p>Now in the repl frame,</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">TEST&gt; (hello-world)
HELLO-WORLD
</code></pre></div>
<p>Now I want to start using <code>cl-ppcre</code>.</p>

<p>Go to <code>package.lisp</code>, modify the form to look like this</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(defpackage #:test
  (:use #:cl #:cl-ppcre))
</code></pre></div>
<p>Then go to <code>test.lisp</code> and add the following</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">(defun my-scan ()
  (scan &quot;(a)*b&quot; &quot;xaaabd&quot;))
</code></pre></div>
<p>Now do <code>M-x slime-reload-system</code>.</p>

<p>In the repl, try <code>(my-scan)</code>.</p>

<p>That should not produce an error. :)</p>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2015-11-08T00:00:00+08:00"><a href="http://ackerleytng.github.io/syscall_define/">November 08, 2015</a></time></span><span class="author vcard"><span class="fn"><a href="http://ackerleytng.github.io/about/" title="About Ackerley Tng">Ackerley Tng</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://ackerleytng.github.io/syscall_define/#disqus_thread">Comment</a></span>
      
      <span class="entry-reading-time pull-right">
        <i class="fa fa-clock-o"></i>
        
        Reading time ~6 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://ackerleytng.github.io/syscall_define/" rel="bookmark" title="SYSCALL_DEFINE" itemprop="url">SYSCALL_DEFINE</a></h1>
    
  </header>
  <div class="entry-content">
    <p>I think macros are pretty interesting... Really wanted to take some time to understand what this particular one means!</p>

<p>For this post, I&#39;ll use Linux 4.3, the latest stable version at the point of writing.</p>

<p>To put things in context, let&#39;s get a concrete example of a syscall -- read.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">SYSCALL_DEFINE3(read, unsigned int, fd, char __user *, buf, size_t, count)
{
        struct fd f = fdget_pos(fd);
        ssize_t ret = -EBADF;

        if (f.file) {
                loff_t pos = file_pos_read(f.file);
                ret = vfs_read(f.file, buf, count, &amp;pos);
                if (ret &gt;= 0)
                        file_pos_write(f.file, pos);
                fdput_pos(f);
        }
        return ret;
}
</code></pre></div>
<p>The macro SYSCALL_DEFINE3 is defined in <code>include/linux/syscalls.h</code>.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#define SYSCALL_DEFINE1(name, ...) SYSCALL_DEFINEx(1, _##name, __VA_ARGS__)
#define SYSCALL_DEFINE2(name, ...) SYSCALL_DEFINEx(2, _##name, __VA_ARGS__)
#define SYSCALL_DEFINE3(name, ...) SYSCALL_DEFINEx(3, _##name, __VA_ARGS__)
#define SYSCALL_DEFINE4(name, ...) SYSCALL_DEFINEx(4, _##name, __VA_ARGS__)
#define SYSCALL_DEFINE5(name, ...) SYSCALL_DEFINEx(5, _##name, __VA_ARGS__)
#define SYSCALL_DEFINE6(name, ...) SYSCALL_DEFINEx(6, _##name, __VA_ARGS__)
</code></pre></div>
<p>Applying that macro, we have</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">SYSCALL_DEFINEx(3, _read, unsigned int, fd, char __user *, buf, size_t, count)
{
        struct file *file;
        ...
</code></pre></div>
<p><code>SYSCALL_DEFINEx</code> is defined as</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#define SYSCALL_DEFINEx(x, sname, ...)                          \
        SYSCALL_METADATA(sname, x, __VA_ARGS__)                 \
        __SYSCALL_DEFINEx(x, sname, __VA_ARGS__)
</code></pre></div>
<p>I&#39;ll deal with <code>__SYSCALL_DEFINEx</code> first.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#define __SYSCALL_DEFINEx(x, name, ...)                                 \
        asmlinkage long sys##name(__MAP(x,__SC_DECL,__VA_ARGS__))       \
                __attribute__((alias(__stringify(SyS##name))));         \
        static inline long SYSC##name(__MAP(x,__SC_DECL,__VA_ARGS__));  \
        asmlinkage long SyS##name(__MAP(x,__SC_LONG,__VA_ARGS__));      \
        asmlinkage long SyS##name(__MAP(x,__SC_LONG,__VA_ARGS__))       \
        {                                                               \
                long ret = SYSC##name(__MAP(x,__SC_CAST,__VA_ARGS__));  \
                __MAP(x,__SC_TEST,__VA_ARGS__);                         \
                __PROTECT(x, ret,__MAP(x,__SC_ARGS,__VA_ARGS__));       \
                return ret;                                             \
        }                                                               \
        static inline long SYSC##name(__MAP(x,__SC_DECL,__VA_ARGS__))
</code></pre></div>
<p><code>asmlinkage</code> is a macro too!</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#define asmlinkage CPP_ASMLINKAGE __attribute__((regparm(0)))
</code></pre></div>
<p>This is an instruction to gcc to expect to get all the arguments for this function from the stack.</p>

<p><code>__MAP</code> is an amazing macro, and the following comment in the code is quite descriptive:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/*
 * __MAP - apply a macro to syscall arguments
 * __MAP(n, m, t1, a1, t2, a2, ..., tn, an) will expand to
 *    m(t1, a1), m(t2, a2), ..., m(tn, an)
 * The first argument must be equal to the amount of type/name
 * pairs given.  Note that this list of pairs (i.e. the arguments
 * of __MAP starting at the third one) is in the same format as
 * for SYSCALL_DEFINE&lt;n&gt;/COMPAT_SYSCALL_DEFINE&lt;n&gt;
 */
#define __MAP0(m,...)
#define __MAP1(m,t,a) m(t,a)
#define __MAP2(m,t,a,...) m(t,a), __MAP1(m,__VA_ARGS__)
#define __MAP3(m,t,a,...) m(t,a), __MAP2(m,__VA_ARGS__)
#define __MAP4(m,t,a,...) m(t,a), __MAP3(m,__VA_ARGS__)
#define __MAP5(m,t,a,...) m(t,a), __MAP4(m,__VA_ARGS__)
#define __MAP6(m,t,a,...) m(t,a), __MAP5(m,__VA_ARGS__)
#define __MAP(n,...) __MAP##n(__VA_ARGS__)
</code></pre></div>
<p><code>__SC_DECL</code> is also a macro!</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#define __SC_DECL(t, a) t a
</code></pre></div>
<p>The kernel code uses this <code>__SC_DECL</code> to declare parameters in the function.</p>

<p>So, in the first line after <code>SYSCALL_DEFINEx</code>, we have</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">__MAP(x,__SC_DECL,__VA_ARGS__)
</code></pre></div>
<p>More concretely, we have </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">__MAP(3,__SC_DECL, unsigned int, fd, char __user *, buf, size_t, count)
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">__MAP3(__SC_DECL, unsigned int, fd, char __user *, buf, size_t, count)
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">__SC_DECL(unsigned int, fd), __MAP2(__SC_DECL, char __user *, buf, size_t, count)
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">__SC_DECL(unsigned int, fd), __SC_DECL(char __user *, buf), __MAP1(__SC_DECL, size_t, count)
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">__SC_DECL(unsigned int, fd), __SC_DECL(char __user *, buf), __SC_DECL(size_t, count)
</code></pre></div>
<p>And then <code>__SC_DECL</code> is also a macro,</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#define __SC_DECL(t, a) t a
</code></pre></div>
<p>So we have</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">unsigned int fd, char __user * buf, size_t count
</code></pre></div>
<p>Hence, the first line of <code>__SYSCALL_DEFINEx</code> expands to</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">asmlinkage long sys_read(unsigned int fd, char __user * buf, size_t count) __attribute__((alias(&quot;SyS_read&quot;)))
</code></pre></div>
<p>Now what is an <code>alias</code>? It&#39;s a gcc <a href="https://gcc.gnu.org/onlinedocs/gcc/Common-Function-Attributes.html#Common-Function-Attributes">attribute</a>. From the <a href="https://gcc.gnu.org/onlinedocs/gcc/Common-Function-Attributes.html#Common-Function-Attributes">gcc site</a>, &quot;The alias attribute causes the declaration to be emitted as an alias for another symbol, which must be specified.&quot;</p>

<p>So as I understand it, <code>sys_read</code> is now the same thing as <code>SyS_read</code>. The following line declares the function,</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">asmlinkage long SyS##name(__MAP(x,__SC_LONG,__VA_ARGS__)); 
</code></pre></div>
<p>And these lines define it:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">asmlinkage long SyS##name(__MAP(x,__SC_LONG,__VA_ARGS__))       \
{                                                               \
        long ret = SYSC##name(__MAP(x,__SC_CAST,__VA_ARGS__));  \
        __MAP(x,__SC_TEST,__VA_ARGS__);                         \
        __PROTECT(x, ret,__MAP(x,__SC_ARGS,__VA_ARGS__));       \
        return ret;                                             \
}                                                               \
</code></pre></div>
<p>Notice that the same <code>__MAP</code> macro is used to apply <code>__SC_LONG</code> in the declaration and definition of <code>SyS_read</code>.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#define __TYPE_IS_L(t)  (__same_type((t)0, 0L))
#define __TYPE_IS_UL(t) (__same_type((t)0, 0UL))
#define __TYPE_IS_LL(t) (__same_type((t)0, 0LL) || __same_type((t)0, 0ULL))
#define __SC_LONG(t, a) __typeof(__builtin_choose_expr(__TYPE_IS_LL(t), 0LL, 0L)) a
</code></pre></div>
<p>I believe <code>__SC_LONG</code> checks the type of <code>t</code> and generates <code>long long a</code> or <code>long a</code> based on whether <code>t</code> was originally of type <code>long long</code>. Isn&#39;t it interesting that the preprocessor can generate code based on macro arguments?</p>

<p>The result of <code>__MAP</code>ing <code>__SC_LONG</code> is</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">asmlinkage long SyS_read(long fd, long buf, long count)
</code></pre></div>
<p>In the next line, we have</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">long ret = SYSC##name(__MAP(x,__SC_CAST,__VA_ARGS__));
</code></pre></div>
<p><code>__SC_CAST</code> is relatively simple, it just basically casts the input arguments to the types suitable for <code>SYSC_read</code>.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#define __SC_CAST(t, a) (t) a
</code></pre></div>
<p>So <code>SyS_read</code> calls <code>SYSC_read</code>, then saves the result in <code>ret</code>. In the next line, we have</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">__MAP(x,__SC_TEST,__VA_ARGS__);
</code></pre></div>
<p>Following that macro in the code, we have</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#define __SC_TEST(t, a) (void)BUILD_BUG_ON_ZERO(!__TYPE_IS_LL(t) &amp;&amp; sizeof(t) &gt; sizeof(long))
</code></pre></div>
<p><code>BUILD_BUG_ON_ZERO</code> is pretty interesting. This <a href="http://stackoverflow.com/questions/9229601/what-is-in-c-code">stackoverflow question</a> has a really good explanation of what this does.</p>

<p><code>BUILD_BUG_ON_ZERO</code> is, I <a href="http://stackoverflow.com/questions/9229601/what-is-in-c-code">quote</a>, &quot;a way to check whether the expression e can be evaluated to be 0, and if not, to fail the build.&quot;</p>

<p>So the line</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">__MAP(x,__SC_TEST,__VA_ARGS__);
</code></pre></div>
<p>tests the type of each argument. After applying de Morgan&#39;s theorem (because of <code>ON_ZERO</code> in <code>BUILD_BUG_ON_ZERO</code>), each argument must either be of type <code>long long</code>, or have a bitwidth less than or equal to that of <code>long</code>.</p>

<p>Moving on to the next line, <code>__SC_ARGS</code> basically extracts the argument and drops the type:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#define __SC_ARGS(t, a) a
</code></pre></div>
<p><code>__PROTECT</code> is a macro, defined as</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#define __PROTECT(...) asmlinkage_protect(__VA_ARGS__)
</code></pre></div>
<p>Its function is well-explained in the comment:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/*
 * Make sure the compiler doesn&#39;t do anything stupid with the
 * arguments on the stack - they are owned by the *caller*, not
 * the callee. This just fools gcc into not spilling into them,
 * and keeps it from doing tailcall recursion and/or using the
 * stack slots for temporaries, since they are live and &quot;used&quot;
 * all the way to the end of the function.
 *
 * NOTE! On x86-64, all the arguments are in registers, so this
 * only matters on a 32-bit kernel.
 */
#define asmlinkage_protect(n, ret, args...) \
        __asmlinkage_protect##n(ret, ##args)
#define __asmlinkage_protect_n(ret, args...) \
        __asm__ __volatile__ (&quot;&quot; : &quot;=r&quot; (ret) : &quot;&quot; (ret), ##args)
#define __asmlinkage_protect0(ret) \
        __asmlinkage_protect_n(ret)
#define __asmlinkage_protect1(ret, arg1) \
        __asmlinkage_protect_n(ret, &quot;m&quot; (arg1))
#define __asmlinkage_protect2(ret, arg1, arg2) \
        __asmlinkage_protect_n(ret, &quot;m&quot; (arg1), &quot;m&quot; (arg2))
#define __asmlinkage_protect3(ret, arg1, arg2, arg3) \
        __asmlinkage_protect_n(ret, &quot;m&quot; (arg1), &quot;m&quot; (arg2), &quot;m&quot; (arg3))
#define __asmlinkage_protect4(ret, arg1, arg2, arg3, arg4) \
        __asmlinkage_protect_n(ret, &quot;m&quot; (arg1), &quot;m&quot; (arg2), &quot;m&quot; (arg3), \
                              &quot;m&quot; (arg4))
#define __asmlinkage_protect5(ret, arg1, arg2, arg3, arg4, arg5) \
        __asmlinkage_protect_n(ret, &quot;m&quot; (arg1), &quot;m&quot; (arg2), &quot;m&quot; (arg3), \
                              &quot;m&quot; (arg4), &quot;m&quot; (arg5))
#define __asmlinkage_protect6(ret, arg1, arg2, arg3, arg4, arg5, arg6) \
        __asmlinkage_protect_n(ret, &quot;m&quot; (arg1), &quot;m&quot; (arg2), &quot;m&quot; (arg3), \
                              &quot;m&quot; (arg4), &quot;m&quot; (arg5), &quot;m&quot; (arg6))
</code></pre></div>
<p>So the <code>SyS_read</code> function essentially just calls <code>SYSC_read</code>, applies some compile-time checks, and returns the result.</p>

<p>Finally! We&#39;re at the definition of the actual syscall.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">static inline long SYSC##name(__MAP(x,__SC_DECL,__VA_ARGS__))
</code></pre></div>
<p>A quick look at <code>SYSCALL_METADATA</code> shows that the macro expands to stuff used for tracing syscalls <code>#ifdef CONFIG_FTRACE_SYSCALLS</code>. </p>

<p>So after all the expansion, </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">SYSCALL_DEFINE3(read, unsigned int, fd, char __user *, buf, size_t, count)
{
        struct fd f = fdget_pos(fd);
        ...
</code></pre></div>
<p>becomes</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">... syscall metadata stuff ...
asmlinkage long sys_read(unsigned int fd, char __user * buf, size_t count) __attribute__((alias(&quot;SyS_read&quot;)))
static inline long SYSC_read(unsigned int fd, char __user * buf, size_t count);
asmlinkage long SyS_read(long fd, long buf, long count);
asmlinkage long SyS_read(long fd, long buf, long count)
{
    long ret = SYSC_read((unsigned int) fd, (char __user *) buf, (size_t) count);
    ... compile-time tests for each argument ...
    ... assembly stuff to prevent clobbering of arguments on stack ...
    return ret;
}
static inline long SYSC_read(unsigned int fd, char __user * buf, size_t count)
{
        struct fd f = fdget_pos(fd);
        ...
</code></pre></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2015-08-08T00:00:00+08:00"><a href="http://ackerleytng.github.io/natday-songs-wordcloud/">August 08, 2015</a></time></span><span class="author vcard"><span class="fn"><a href="http://ackerleytng.github.io/about/" title="About Ackerley Tng">Ackerley Tng</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://ackerleytng.github.io/natday-songs-wordcloud/#disqus_thread">Comment</a></span>
      
      <span class="entry-reading-time pull-right">
        <i class="fa fa-clock-o"></i>
        
        Reading time ~1 minute
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://ackerleytng.github.io/natday-songs-wordcloud/" rel="bookmark" title="National Day Songs WordCloud!" itemprop="url">National Day Songs WordCloud!</a></h1>
    
  </header>
  <div class="entry-content">
    <p>I wanted to find out which words appear most often in our National Day songs, so here&#39;s a WordCloud!</p>

<p><img src="http://ackerleytng.github.io/post_images/natday-songs-wordcloud.png" alt="natday-songs-wordcloud"></p>

<p>Here&#39;s what I did:</p>

<ol>
<li>I got the list of songs from <a href="http://www.straitstimes.com/singapore/dick-lee-unveils-2015-ndp-song-our-singapore-revisit-past-national-day-parade-theme-songs">here</a></li>
<li>I googled the song titles for the lyrics, and then I checked the lyrics that I copied by listening to all the songs</li>
<li>I put all the lyrics into one text file, I duplicated songs as necessary (e.g. Home was used as the national day song in two years, 1998 and 2004). I also expanded the lyrics by copying and pasting choruses as necessary, so that the lyrics are written out as sung</li>
<li>I manually removed the contractions (I&#39;ll was replaced with I will etc). I think is fairer because then &#39;ll and will won&#39;t be considered two different words</li>
<li>Used this <a href="http://ackerleytng.github.io/post_downloads/parse-natday-songs.py">script</a> to generate the WordCloud</li>
</ol>

  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2015-04-11T00:00:00+08:00"><a href="http://ackerleytng.github.io/linux-nfs-mini2440/">April 11, 2015</a></time></span><span class="author vcard"><span class="fn"><a href="http://ackerleytng.github.io/about/" title="About Ackerley Tng">Ackerley Tng</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://ackerleytng.github.io/linux-nfs-mini2440/#disqus_thread">Comment</a></span>
      
      <span class="entry-reading-time pull-right">
        <i class="fa fa-clock-o"></i>
        
        Reading time ~3 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://ackerleytng.github.io/linux-nfs-mini2440/" rel="bookmark" title="Putting Linux on mini2440 with nfs root filesystem" itemprop="url">Putting Linux on mini2440 with nfs root filesystem</a></h1>
    
  </header>
  <div class="entry-content">
    <p>The <a href="/linux-mini2440/">previous post</a> showed how to put Linux on the mini2440.</p>

<p>To facilitate development on the mini2440, it is advantageous to have a network file system as a rootfs:</p>

<ul>
<li>Easily compile on the host and run it on the mini2440 without having to do troublesome transfers</li>
<li>Won&#39;t be wasting write cycles on the flash</li>
</ul>

<h1>Setting up the nfs server</h1>
<div class="highlight"><pre><code class="language-text" data-lang="text">sudo apt-get install nfs-kernel-server
</code></pre></div>
<p>You just need to add a single line to the configuration in <code>/etc/exports</code></p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/export/fs 192.168.1.0/24(rw,insecure,no_subtree_check,async,no_root_squash)
</code></pre></div>
<p>Untar <code>output/images/rootfs.tar</code> into <code>/export/fs</code>.</p>

<p>Your <code>/export/fs</code> should look like this:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ ls -al /export/fs/
total 72
drwxrwxr-x 18 root root 4096 Apr  6 23:21 .
drwxr-xr-x  3 root root 4096 Apr  6 23:21 ..
drwxrwxr-x  2 root root 4096 Apr  5 21:59 bin
drwxr-xr-x  3 root root 4096 Apr 11 11:14 dev
drwxr-xr-x  5 root root 4096 Apr 11 11:15 etc
drwxrwxr-x  3 root root 4096 Mar  2 05:26 home
drwxrwxr-x  3 root root 4096 Apr  5 21:59 lib
lrwxrwxrwx  1 root root    3 Apr  5 21:11 lib32 -&gt; lib
lrwxrwxrwx  1 root root   11 Apr  5 21:45 linuxrc -&gt; bin/busybox
drwxrwxr-x  2 root root 4096 Mar  2 05:26 media
drwxrwxr-x  2 root root 4096 Mar  2 05:26 mnt
drwxrwxr-x  2 root root 4096 Mar  2 05:26 opt
drwxrwxr-x  2 root root 4096 Mar  2 05:26 proc
drwx------  2 root root 4096 Apr 11 11:16 root
drwxrwxr-x  2 root root 4096 Apr 11 11:14 run
drwxrwxr-x  2 root root 4096 Apr  5 21:59 sbin
drwxrwxr-x  2 root root 4096 Mar  2 05:26 sys
drwxrwxrwt  3 root root 4096 Apr  5 21:59 tmp
drwxrwxr-x  6 root root 4096 Apr  5 21:45 usr
drwxrwxr-x  4 root root 4096 Apr  5 22:01 var
</code></pre></div>
<p>Note that the symlinks should be there.</p>

<p>You might need to turn off the firewall to enable access</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">sudo disable ufw
</code></pre></div>
<p>If you wish to test this setup, you could use another linux/mac computer:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ showmount -e 192.168.1.50
Exports list on 192.168.1.50:
/export/fs                          192.168.1.0/24
/export                             192.168.1.0/24
</code></pre></div>
<p>and then</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ mkdir tmp
$ mount -t nfs 192.168.1.50:/export/fs/ tmp/
$ ls tmp/
bin     dev     etc     home    lib     lib32   linuxrc media   mnt     opt     proc    root    run     sbin    sys     tmp     usr     var
</code></pre></div>
<p>The following is <em>wrong</em>; you won&#39;t be able to boot.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ ls tmp/
fs
</code></pre></div>
<p>Looking in system logs might help with debugging your nfs setup</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">tail -f /var/log/syslog
</code></pre></div>
<p>Now go to the mini2440. Interrupt boot if necessary by pressing enter at this prompt</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Hit any key to stop autoboot:  0
MINI2440 #
</code></pre></div>
<p>Then</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440 # setenv bootargs console=ttySAC0,115200 root=/dev/nfs nfsroot=192.168.1.50:/export/fs rw ip=192.168.1.60 noinitrd
MINI2440 # saveenv
MINI2440 # boot
</code></pre></div>
<p><code>ip</code> is the address you want to assign to your mini2440 and <code>nfsroot</code> should point the mini2440 to your server.</p>

<p><code>/dev/nfs</code> need not exist in <code>/export/fs/dev</code> for mounting to be successful.</p>

<h2>Loading the kernel over nfs too!</h2>

<p>Go back to <code>/etc/exports</code> and add a second line</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/export/fs     192.168.1.*(rw,insecure,no_subtree_check,async,no_root_squash)
/export/kernel 192.168.1.*(ro,insecure,no_subtree_check,async)
</code></pre></div><div class="highlight"><pre><code class="language-text" data-lang="text">$ sudo service nfs-kernel-server restart
</code></pre></div>
<p>Then on the mini2440</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440 # setenv bootcmd nfs 0x32000000 192.168.1.50:/export/kernel/uImage \; bootm
MINI2440 # saveenv
Saving Environment to NAND...
Erasing Nand...Writing to Nand... done
MINI2440 # boot
</code></pre></div>
<p>Full <code>printenv</code> on mini2440:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440 # printenv
bootdelay=3
baudrate=115200
ethaddr=08:08:11:18:12:27
usbtty=cdc_acm
mini2440=mini2440=0tb
bootargs_base=console=ttySAC0,115200 noinitrd
bootargs_init=init=/sbin/init
root_nand=root=/dev/mtdblock3 rootfstype=jffs2
root_mmc=root=/dev/mmcblk0p2 rootdelay=2
set_root_nfs=setenv root_nfs root=/dev/nfs rw nfsroot=${serverip}:${root_nfs}
ifconfig_static=run setenv ifconfig ip=${ipaddr}:${serverip}::${netmask}:mini2440:eth0
ifconfig_dhcp=run setenv ifconfig ip=dhcp
ifconfig=ip=dhcp
set_bootargs_mmc=setenv bootargs ${bootargs_base} ${bootargs_init} ${mini2440} ${root_mmc}
set_bootargs_nand=setenv bootargs ${bootargs_base} ${bootargs_init} ${mini2440} ${root_nand}
set_bootargs_nfs=run set_root_nfs; setenv bootargs ${bootargs_base} ${bootargs_init} ${mini2440} ${root_nfs} ${ifconfig}
mtdids=nand0=mini2440-nand
mtdparts=mtdparts=mini2440-nand:0x00040000(u-boot),0x00020000(u-boot_env),0x00500000(kernel),0x0faa0000(rootfs)
filesize=51A630
fileaddr=32000000
netmask=255.255.255.0
ipaddr=192.168.1.60
serverip=192.168.1.50
root_nfs=/export/fs
bootargs=console=ttySAC0,115200 root=/dev/nfs nfsroot=192.168.1.50:/export/fs rw ip=192.168.1.60 noinitrd
bootcmd=nfs 0x32000000 192.168.1.50:/export/kernel/uImage ; bootm
partition=nand0,0
mtddevnum=0
mtddevname=u-boot
</code></pre></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->

<article class="hentry">
  <header>
    <div class="entry-meta">
      <span class="entry-date date published updated"><time datetime="2015-04-06T00:00:00+08:00"><a href="http://ackerleytng.github.io/linux-jffs-mini2440/">April 06, 2015</a></time></span><span class="author vcard"><span class="fn"><a href="http://ackerleytng.github.io/about/" title="About Ackerley Tng">Ackerley Tng</a></span></span>&nbsp; &bull; &nbsp;<span class="entry-comments"><a href="http://ackerleytng.github.io/linux-jffs-mini2440/#disqus_thread">Comment</a></span>
      
      <span class="entry-reading-time pull-right">
        <i class="fa fa-clock-o"></i>
        
        Reading time ~2 minutes
      </span><!-- /.entry-reading-time -->
      
    </div><!-- /.entry-meta -->
    
      <h1 class="entry-title"><a href="http://ackerleytng.github.io/linux-jffs-mini2440/" rel="bookmark" title="Putting Linux on mini2440 with jffs2 filesystem" itemprop="url">Putting Linux on mini2440 with jffs2 filesystem</a></h1>
    
  </header>
  <div class="entry-content">
    <p>The <a href="/linux-mini2440/">previous post</a> showed how to put Linux on the mini2440.</p>

<p>If you log in at the login prompt by entering the username root, you would be taken to <code>/root</code>. If you try writing to the filesystem,</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"># touch test
</code></pre></div>
<p>and you restart the device</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"># reboot
</code></pre></div>
<p>you will find that the file is not saved. To be able to write to the flash, we can place a jffs2 filesystem on the mini2440.</p>

<h2>Building the kernel and root file system</h2>

<p>Using the same version of buildroot from the <a href="/linux-mini2440/">previous post</a>, I did <code>make menuconfig</code>.</p>

<p>Deselect <code>initial RAM filesystem linked into linux kernel</code> and deselect <code>cpio the root filesystem (for use as an initial RAM filesystem)</code></p>

<p>I also selected <code>jffs2 root filesystem</code> and for <code>Flash Type</code>, I selected <code>NAND flash with 2kB Page and 128 kB erasesize</code></p>

<p>Then...</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">make
</code></pre></div>
<h2>Conceptually,</h2>

<p>You want to put U-Boot, a bootloader, into NAND flash, which will then load your linux kernel, which would in turn load your root filesystem.</p>

<p>You can use the U-Boot bootloader if it is already on the mini2440&#39;s NAND flash.</p>

<h2>Transferring uImage into NAND flash</h2>

<p>Find the address of the kernel partition:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440 # mtdparts

device nand0 &lt;mini2440-nand&gt;, # parts = 4
 #: name                        size            offset          mask_flags
 0: u-boot              0x00040000      0x00000000      0
 1: u-boot_env          0x00020000      0x00040000      0
 2: kernel              0x00500000      0x00060000      0
 3: rootfs              0x0faa0000      0x00560000      0

active partition: nand0,0 - (u-boot) 0x00040000 @ 0x00000000

defaults:
mtdids  : nand0=mini2440-nand
mtdparts: &lt;NULL&gt;
</code></pre></div>
<p>Erase the kernel partition:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440# nand erase 60000 500000
</code></pre></div>
<p>Download uImage from Linux PC over LAN into RAM, at 0x32000000 again. First place <code>uImage</code> into <code>/tftpboot</code> (Google how to set up tftp).</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440# tftp 32000000 uImage
</code></pre></div>
<p>Copy uImage from ram into NAND</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440# nand write.e 32000000 60000 &lt;size-of-uImage-in-hex&gt;
</code></pre></div>
<p>Set the boot command to load kernel image from NAND flash.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440# setenv bootcmd &#39;nboot.e kernel;bootm&#39;
MINI2440# saveenv
</code></pre></div>
<h2>Transferring <code>rootfs.jffs2</code> into NAND flash</h2>

<p>Copy <code>rootfs.jffs2</code> from <code>buildroot-2015.02/output/images/</code> into <code>/tftpboot/</code>.</p>

<p>Erase the rootfs partition:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440# nand erase rootfs
</code></pre></div>
<p>Download <code>rootfs.jffs2</code> from Linux PC over LAN into RAM, at 0x32000000 again.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440# tftp 32000000 rootfs.jffs2
</code></pre></div>
<p>Copy uImage from ram into NAND</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440# nand write.e 32000000 560000 &lt;size-of-rootfs.jffs2-in-hex&gt;
</code></pre></div>
<p>Set the boot command to load kernel image from NAND flash.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440# setenv bootcmd &#39;nboot.e kernel;bootm&#39;
MINI2440# setenv bootargs &#39;root=/dev/mtdblock3 rootfstype=jffs2 console=ttySAC0,115200&#39;
MINI2440# saveenv
</code></pre></div>
<p>Power cycle the mini2440.</p>

<h2>Full U-Boot environment for reference</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">MINI2440 # printenv
bootargs=root=/dev/mtdblock3 rootfstype=jffs2 console=ttySAC0,115200
bootdelay=3
baudrate=115200
ethaddr=08:08:11:18:12:27
usbtty=cdc_acm
mini2440=mini2440=0tb
bootargs_base=console=ttySAC0,115200 noinitrd
bootargs_init=init=/sbin/init
root_nand=root=/dev/mtdblock3 rootfstype=jffs2
root_mmc=root=/dev/mmcblk0p2 rootdelay=2
root_nfs=/mnt/nfs
set_root_nfs=setenv root_nfs root=/dev/nfs rw nfsroot=${serverip}:${root_nfs}
ifconfig_static=run setenv ifconfig ip=${ipaddr}:${serverip}::${netmask}:mini2440:eth0
ifconfig_dhcp=run setenv ifconfig ip=dhcp
ifconfig=ip=dhcp
set_bootargs_mmc=setenv bootargs ${bootargs_base} ${bootargs_init} ${mini2440} ${root_mmc}
set_bootargs_nand=setenv bootargs ${bootargs_base} ${bootargs_init} ${mini2440} ${root_nand}
set_bootargs_nfs=run set_root_nfs; setenv bootargs ${bootargs_base} ${bootargs_init} ${mini2440} ${root_nfs} ${ifconfig}
mtdids=nand0=mini2440-nand
mtdparts=mtdparts=mini2440-nand:0x00040000(u-boot),0x00020000(u-boot_env),0x00500000(kernel),0x0faa0000(rootfs)
bootcmd=nboot.e kernel;bootm
filesize=51A630
fileaddr=32000000
netmask=255.255.255.0
ipaddr=192.168.1.60
serverip=192.168.1.50
partition=nand0,0
mtddevnum=0
mtddevname=u-boot
</code></pre></div>
  </div><!-- /.entry-content -->
</article><!-- /.hentry -->


<div class="pagination">
  
    Previous
  
  <ul class="inline-list">
    <li>
      
        <span class="current-page">1</span>
      
    </li>
    
      <li>
        
          <a href="http://ackerleytng.github.io/page2">2</a>
        
      </li>
    
      <li>
        
          <a href="http://ackerleytng.github.io/page3">3</a>
        
      </li>
    
      <li>
        
          <a href="http://ackerleytng.github.io/page4">4</a>
        
      </li>
    
      <li>
        
          <a href="http://ackerleytng.github.io/page5">5</a>
        
      </li>
    
      <li>
        
          <a href="http://ackerleytng.github.io/page6">6</a>
        
      </li>
    
  </ul>
  
    <a href="http://ackerleytng.github.io/page2" class="btn">Next</a>
  
</div><!-- /.pagination -->

</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2015 Ackerley Tng. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://ackerleytng.github.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://ackerleytng.github.io/assets/js/scripts.min.js"></script>

          

</body>
</html>